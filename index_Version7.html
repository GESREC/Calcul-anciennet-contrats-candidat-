<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi des candidats - Ancienneté Services Publics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --main: #4a90e2;
      --main-dark: #357abd;
      --bg: #f7f9fc;
      --white: #fff;
      --shadow: 0 4px 20px rgba(0,0,0,0.07);
      --border-radius: 10px;
      --table-head-bg: #eaf1fb;
      --danger: #ff5c5c;
      --success: #2ecc71;
      --note-bg: #fffbe5;
      --note-border: #ffe066;
      --note-text: #d35400;
      --input-bg: #f2f6fb;
      --select-bg: #eaf1fb;
    }
    html, body {
      background: var(--bg);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      max-width: 760px;
      margin: 40px auto;
      padding: 24px;
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
    }
    h1 {
      text-align: center;
      color: var(--main-dark);
      font-size: 2.1em;
      margin-top: 0;
      margin-bottom: 22px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    #candidateForm, #candidateSearch {
      padding: 16px 18px;
      background: var(--table-head-bg);
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(74,144,226,0.07);
    }
    #candidateForm .flex-row,
    #candidateSearch .flex-row {
      display: flex;
      gap: 18px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 0.98em;
      color: #333;
      min-width: 140px;
      margin-bottom: 0;
    }
    input[type="text"],
    select {
      padding: 8px 10px;
      border: 1px solid #bfc9d8;
      border-radius: 6px;
      font-size: 1em;
      margin-top: 4px;
      background: var(--input-bg);
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input[type="text"]:focus, select:focus {
      border-color: var(--main);
      outline: none;
      background: #fff;
    }
    select {
      background: var(--select-bg);
      min-width: 180px;
    }
    .input-small { width: 110px; }
    button[type="submit"], #calculateBtn, #changeCandidateBtn {
      background: var(--main);
      color: var(--white);
      border: none;
      border-radius: 7px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.09);
      transition: background 0.2s, box-shadow 0.2s;
      margin-top: 8px;
      font-weight: 600;
    }
    button[type="submit"]:hover, #calculateBtn:hover, #changeCandidateBtn:hover {
      background: var(--main-dark);
      box-shadow: 0 4px 16px rgba(74, 144, 226, 0.13);
    }
    #contractsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      margin-bottom: 16px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(74,144,226,0.07);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: center;
      font-size: 1em;
    }
    th {
      background: var(--table-head-bg);
      color: var(--main-dark);
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background: #f1f6fa;
    }
    tr:last-child td {
      border-bottom: none;
    }
    td button {
      background: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 5px;
      padding: 5px 14px;
      font-size: 0.95em;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 1px 4px rgba(255,92,92,0.10);
      transition: background 0.15s;
    }
    td button:hover {
      background: #e04a4a;
    }
    #result {
      margin-top: 28px;
      text-align: center;
      font-size: 1.15em;
      font-weight: 600;
      color: var(--success);
      background: #eafaf1;
      border-radius: 7px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(46,204,113,0.08);
      letter-spacing: 1px;
      min-height: 36px;
    }
    .note {
      margin-top: 32px;
      margin-bottom: 0;
      padding: 18px 16px;
      background: var(--note-bg);
      border-left: 8px solid var(--note-border);
      border-radius: 8px;
      color: var(--note-text);
      font-size: 1.15em;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(223,196,73,0.10);
      text-align: center;
      line-height: 1.5em;
      letter-spacing: 0.5px;
      animation: fadein 1.8s;
    }
    .note strong {
      color: #bf8000;
      background: #fff7d6;
      padding: 2px 6px;
      border-radius: 5px;
      font-weight: 900;
      font-size: 1.1em;
    }
    .candidat-selected {
      margin: 18px 0 8px 0;
      padding: 14px;
      background: #eaf1fb;
      border-radius: 7px;
      box-shadow: 0 2px 8px rgba(74,144,226,0.08);
      font-size: 1.12em;
    }
    .candidat-selected .info {
      margin-bottom: 2px;
      font-weight: 600;
      color: var(--main-dark);
    }
    .candidat-selected .concours {
      color: #333;
      font-weight: 500;
    }
    #changeCandidateBtn {
      margin-left: 10px;
      margin-bottom: 0;
      padding: 7px 16px;
      font-size: 0.97em;
      background: #eab900;
      color: #fff;
      border-radius: 5px;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(234,185,0,0.09);
      transition: background 0.2s;
    }
    #changeCandidateBtn:hover {
      background: #d4a300;
    }
    @keyframes fadein {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @media (max-width: 650px) {
      body {
        padding: 8px;
        max-width: 97vw;
      }
      .flex-row {
        flex-direction: column;
        gap: 12px;
      }
      #candidateForm, #candidateSearch {
        padding: 10px 8px;
      }
      th, td {
        padding: 8px 2px;
        font-size: 0.95em;
      }
      .input-small { width: 90px; }
      .note { font-size: 1em; padding: 13px 6px; }
      .candidat-selected { font-size: 1em; }
    }
  </style>
</head>
<body>
  <h1>Suivi des candidats — Ancienneté Services Publics</h1>

  <form id="candidateForm">
    <div class="flex-row">
      <label>Nom :
        <input type="text" id="nom" required />
      </label>
      <label>Prénom :
        <input type="text" id="prenom" required />
      </label>
      <label>Concours préparé :
        <input type="text" id="concours" required />
      </label>
      <button type="submit">Créer / Sélectionner ce candidat</button>
    </div>
  </form>

  <form id="candidateSearch">
    <div class="flex-row">
      <label>Rechercher un candidat :
        <select id="candidateList">
          <option value="">-- Sélectionner --</option>
        </select>
      </label>
    </div>
  </form>

  <div id="selectedCandidatInfo" style="display:none;"></div>

  <div id="contratsSection" style="display:none;">
    <form id="contractForm">
      <div class="flex-row">
        <label>Date début (JJ/MM/AAAA) :
          <input type="date" id="startDate" required class="input-small" />
        </label>
        <label>Date fin (JJ/MM/AAAA) :
          <input type="date" id="endDate" required class="input-small" />
        </label>
        <label>Heures/semaine (18 = 100%) :
          <input type="number" step="0.01" id="hours" min="0.01" max="18" required class="input-small" />
        </label>
        <label>Quotité (%) :
          <input type="number" step="0.01" id="percentage" min="0.01" max="100" required class="input-small" />
        </label>
        <button type="submit">Ajouter contrat</button>
      </div>
    </form>

    <table id="contractsTable">
      <thead>
        <tr>
          <th>Date Début</th>
          <th>Date Fin</th>
          <th>Heures</th>
          <th>Quotité (%)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="calculateBtn">Calculer Ancienneté</button>
    <div id="result"></div>
  </div>

  <div class="note">
    <strong>Pour rappel&nbsp;:</strong> Le calcul des années de services publics se fait sur la base d'une année scolaire.<br>
    Sur cette année, si vous avez travaillé <strong>6 mois ou plus à 50% ou plus</strong>, vous cumulez <strong>1 an</strong>, sinon vous cumulez <strong>6 mois</strong>.
  </div>

  <script>
    // ---------- Stockage candidats ----------
    function getCandidates() {
      return JSON.parse(localStorage.getItem('candidats') || '[]');
    }
    function saveCandidates(cands) {
      localStorage.setItem('candidats', JSON.stringify(cands));
    }
    function findCandidateId(nom, prenom, concours) {
      const cands = getCandidates();
      return cands.findIndex(c =>
        c.nom.trim().toLowerCase() === nom.trim().toLowerCase() &&
        c.prenom.trim().toLowerCase() === prenom.trim().toLowerCase() &&
        c.concours.trim().toLowerCase() === concours.trim().toLowerCase()
      );
    }
    function getCandidate(id) {
      const cands = getCandidates();
      return cands[id] || null;
    }
    function updateCandidate(id, cand) {
      const cands = getCandidates();
      cands[id] = cand;
      saveCandidates(cands);
    }

    // ---------- Initialisation ----------
    let selectedCandidateId = null;
    let contracts = [];

    function refreshCandidateList() {
      const cands = getCandidates();
      const sel = document.getElementById('candidateList');
      sel.innerHTML = '<option value="">-- Sélectionner --</option>';
      cands.forEach((c, idx) => {
        sel.innerHTML += `<option value="${idx}">${c.nom.toUpperCase()} ${c.prenom} (${c.concours})</option>`;
      });
    }
    refreshCandidateList();

    // ---------- Ajout/sélection d'un candidat ----------
    document.getElementById('candidateForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const nom = document.getElementById('nom').value;
      const prenom = document.getElementById('prenom').value;
      const concours = document.getElementById('concours').value;
      let cands = getCandidates();
      let idx = findCandidateId(nom, prenom, concours);

      if (idx === -1) {
        idx = cands.length;
        cands.push({ nom, prenom, concours, contracts: [] });
        saveCandidates(cands);
        refreshCandidateList();
        alert('Candidat ajouté et sélectionné !');
      } else {
        alert('Candidat déjà existant, sélectionné !');
      }
      selectCandidate(idx);
    });

    document.getElementById('candidateList').addEventListener('change', function(e) {
      const idx = e.target.value;
      if (idx !== "") selectCandidate(Number(idx));
    });

    function selectCandidate(idx) {
      selectedCandidateId = idx;
      const cand = getCandidate(idx);
      if (!cand) return;

      // Affiche infos candidat
      document.getElementById('selectedCandidatInfo').style.display = '';
      document.getElementById('selectedCandidatInfo').innerHTML =
        `<div class="candidat-selected">
          <span class="info">Candidat sélectionné : <strong>${cand.nom.toUpperCase()} ${cand.prenom}</strong></span>
          <span class="concours">Concours préparé : <strong>${cand.concours}</strong></span>
          <button id="changeCandidateBtn">Changer de candidat</button>
        </div>`;
      document.getElementById('contratsSection').style.display = '';
      contracts = cand.contracts || [];
      renderContractsTable();
      document.getElementById('result').textContent = "";
      document.getElementById('contractForm').reset();
      document.getElementById('hours').value = '';
      document.getElementById('percentage').value = '';
      document.getElementById('changeCandidateBtn').onclick = function() {
        selectedCandidateId = null;
        contracts = [];
        document.getElementById('selectedCandidatInfo').style.display = 'none';
        document.getElementById('contratsSection').style.display = 'none';
        document.getElementById('candidateList').value = '';
      };
    }

    // ---------- Contrats du candidat ----------
    const hoursInput = document.getElementById('hours');
    const percInput = document.getElementById('percentage');
    const MAX_HOURS = 18;

    hoursInput.addEventListener('input', function() {
      let h = parseFloat(hoursInput.value);
      if (isNaN(h)) h = 0;
      let p = Math.round((h / MAX_HOURS) * 100 * 100) / 100;
      percInput.value = p > 0 ? p : '';
    });
    percInput.addEventListener('input', function() {
      let p = parseFloat(percInput.value);
      if (isNaN(p)) p = 0;
      let h = Math.round((p / 100) * MAX_HOURS * 100) / 100;
      hoursInput.value = h > 0 ? h : '';
    });

    function formatDateFR(dateString) {
      if (!dateString) return '';
      const [year, month, day] = dateString.split("-");
      return `${day}/${month}/${year}`;
    }

    document.getElementById('contractForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if (selectedCandidateId === null) {
        alert('Veuillez sélectionner un candidat.');
        return;
      }
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const hours = parseFloat(hoursInput.value);
      const percentage = parseFloat(percInput.value);

      if (startDate > endDate) {
        alert('La date de début doit être avant la date de fin.');
        return;
      }
      if (isNaN(hours) || isNaN(percentage) || hours <= 0 || percentage <= 0 || percentage > 100 || hours > MAX_HOURS) {
        alert('Veuillez saisir des valeurs d\'heures et de quotité correctes.');
        return;
      }

      contracts.push({startDate, endDate, hours, percentage});
      saveContractsForCandidate(selectedCandidateId, contracts);
      renderContractsTable();
      document.getElementById('contractForm').reset();
      hoursInput.value = '';
      percInput.value = '';
    });

    function renderContractsTable() {
      const tbody = document.querySelector('#contractsTable tbody');
      tbody.innerHTML = '';
      contracts.forEach((c, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDateFR(c.startDate)}</td>
          <td>${formatDateFR(c.endDate)}</td>
          <td>${c.hours.toFixed(2)}</td>
          <td>${c.percentage.toFixed(2)}</td>
          <td><button type="button" onclick="removeContract(${i})">Supprimer</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.removeContract = function(idx) {
      contracts.splice(idx, 1);
      saveContractsForCandidate(selectedCandidateId, contracts);
      renderContractsTable();
    };

    function saveContractsForCandidate(idx, contractsArr) {
      const cand = getCandidate(idx);
      cand.contracts = contractsArr;
      updateCandidate(idx, cand);
    }

    // -------- Correction de la logique année scolaire --------
    function calculateSeniority(contracts) {
      function parseDate(s) { return new Date(s + 'T00:00:00'); }
      // Regroupement par année scolaire (1er sept - 31 août)
      const years = {};
      contracts.forEach(c => {
        let start = parseDate(c.startDate);
        let end = parseDate(c.endDate);
        // Trouver toutes les années scolaires traversées par le contrat
        let currYear = (start.getMonth() + 1 >= 9) ? start.getFullYear() : start.getFullYear() - 1;
        let schoolStart = new Date(currYear + '-09-01T00:00:00');
        let schoolEnd = new Date((currYear + 1) + '-08-31T00:00:00');
        while (end >= schoolStart) {
          // Calculer la période d'intersection entre le contrat et l'année scolaire
          let periodStart = start > schoolStart ? start : schoolStart;
          let periodEnd = end < schoolEnd ? end : schoolEnd;
          if (periodEnd >= periodStart) {
            if (!years[currYear]) years[currYear] = [];
            years[currYear].push({start: periodStart, end: periodEnd, hours: c.hours, percentage: c.percentage});
          }
          currYear++;
          schoolStart = new Date(currYear + '-09-01T00:00:00');
          schoolEnd = new Date((currYear + 1) + '-08-31T00:00:00');
        }
      });

      let totalYears = 0;
      for (const year in years) {
        let jours50Plus = 0;
        let minDate = null;
        let maxDate = null;

        years[year].forEach(c => {
          let timeDiff = (c.end - c.start) / (1000 * 3600 * 24) + 1;
          let quotite = c.hours / MAX_HOURS;
          if (quotite >= 0.5) jours50Plus += timeDiff;
          if (!minDate || c.start < minDate) minDate = c.start;
          if (!maxDate || c.end > maxDate) maxDate = c.end;
        });

        // Année scolaire complète : du 1er septembre au 31 août (365 jours)
        let schoolYearStart = new Date(year + '-09-01T00:00:00');
        let schoolYearEnd = new Date((parseInt(year) + 1) + '-08-31T00:00:00');
        let schoolYearDays = (schoolYearEnd - schoolYearStart) / (1000 * 3600 * 24) + 1; // 365 ou 366

        // Vérifier si le contrat couvre toute l'année scolaire à +50%
        let coversFullYear = (minDate <= schoolYearStart) && (maxDate >= schoolYearEnd) && (jours50Plus >= schoolYearDays);

        if (coversFullYear) totalYears += 1;
        else if (jours50Plus >= 183) totalYears += 0.5;
        // sinon, rien n'est ajouté
      }

      const annees = Math.floor(totalYears);
      const mois = Math.round((totalYears - annees) * 12);
      return {annees, mois};
    }

    document.getElementById('calculateBtn').addEventListener('click', () => {
      if (!contracts || contracts.length === 0) {
        document.getElementById('result').textContent = "";
        alert('Veuillez ajouter au moins un contrat.');
        return;
      }
      const seniorite = calculateSeniority(contracts);
      document.getElementById('result').textContent =
        `Ancienneté totale : ${seniorite.annees} an(s) et ${seniorite.mois} mois`;
    });
  </script>
</body>
</html>